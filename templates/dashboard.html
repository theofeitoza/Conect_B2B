<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Dashboard - Connecta B2B</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}">
    <style>
        .dashboard-container { padding: 40px 20px; }
        .section-container { margin-top: 40px; } .section-container h3 { margin-bottom: 20px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .announcement-bar { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
        .announcement-bar h4 { margin: 0 0 10px 0; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background-color: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h4 { margin: 0 0 10px 0; color: #555; font-size: 1rem; } .stat-card p { font-size: 2rem; font-weight: bold; color: #0056b3; }
        .tabs { border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tabs a { padding: 10px 20px; display: inline-block; text-decoration: none; color: #555; font-weight: bold; border-bottom: 3px solid transparent; }
        .tabs a.active { color: #007bff; border-bottom-color: #007bff; }
        .quote-item, .quote-group-item { background-color: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; text-decoration: none; color: inherit; display: block; transition: box-shadow 0.2s ease; }
        .quote-item:hover, .quote-group-item:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .status-badge { padding: 3px 8px; font-size: 0.8rem; border-radius: 12px; color: #fff; font-weight: bold; }
        .status-Pendente { background-color: #ffc107; color: #333; } .status-Respondido { background-color: #007bff; }
        .status-Aceito { background-color: #28a745; } .status-Recusado { background-color: #dc3545; }
        .product-management-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .product-management-card { border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .product-management-card img { width: 100%; height: 180px; object-fit: cover; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .product-management-info { padding: 15px; flex-grow: 1; }
        .product-management-info h4 { margin: 0 0 10px 0; font-size: 1.2rem; color: #333; }
        .product-management-actions { padding: 15px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .product-management-actions a, .product-management-actions button { flex: 1; text-align: center; padding: 8px; border-radius: 5px; text-decoration: none; border: 1px solid transparent; cursor: pointer; font-weight: bold; font-size: 0.9rem; width: 100%; }
        .btn-edit { background-color: #007bff; color: white; }
        .btn-delete { background-color: transparent; color: #dc3545; border-color: #dc3545; }
        .verified-seal-small { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="{{ url_for('home') }}" style="text-decoration: none;"><h1 class="logo">Connecta B2B</h1></a>
            <nav class="main-nav">
                <ul>
                    <li><a href="{{ url_for('products') }}">Marketplace</a></li>
                    {% if session.user_type == 'buyer' %}
                    <li><a href="{{ url_for('view_cart') }}" style="position: relative; padding: 5px;">&#128722; {% if cart_item_count > 0 %}<span style="position: absolute; top: 0; right: -5px; background: #007bff; color: white; border-radius: 50%; padding: 2px 5px; font-size: 0.7rem;">{{ cart_item_count }}</span>{% endif %}</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('notifications') }}" style="position: relative; padding: 5px;">&#128276; {% if unread_notifications > 0 %}<span style="position: absolute; top: 0; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 5px; font-size: 0.7rem;">{{ unread_notifications }}</span>{% endif %}</a></li>
                    <li><a href="{{ url_for('company_profile', company_id=session.company_id) }}">Meu Perfil</a></li>
                    {% if session.is_admin %}<li><a href="{{ url_for('admin.index') }}" style="color: #ffc107; font-weight: bold;">Painel Admin</a></li>{% endif %}
                    <li><a href="{{ url_for('dashboard') }}"><strong>Olá, {{ session.company_name }}</strong></a></li>
                    <li><a href="{{ url_for('logout') }}" class="login-button">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main class="container dashboard-container">
        {% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}{% for c, m in messages %}<div class="flash-messages" style="margin-bottom:20px;"><li class="{{ c }}">{{ m }}</li></div>{% endfor %}{% endif %}{% endwith %}
        {% if active_announcement %}<div class="announcement-bar"><h4>{{ active_announcement.title }}</h4><p>{{ active_announcement.content }}</p></div>{% endif %}
        <div class="dashboard-header">
            <h2>Painel de Controle</h2>
            <a href="{{ url_for('export_quotes') }}" class="cta-button" style="background-color:#17a2b8; text-decoration: none;">Exportar Relatório (CSV)</a>
        </div>
        <div class="analytics-grid">
            {% if session.user_type == 'supplier' %}
                <div class="stat-card"><h4>Cotações Recebidas</h4><p>{{ analytics.total_quotes }}</p></div>
                <div class="stat-card"><h4>Taxa de Aceitação</h4><p>{{ "%.1f"|format(analytics.acceptance_rate) }}%</p></div>
                <div class="stat-card"><h4>Média de Avaliação</h4><p>{{ "%.1f"|format(analytics.avg_rating) }}/5.0</p></div>
            {% else %}
                <div class="stat-card"><h4>Cotações Enviadas</h4><p>{{ analytics.total_sent }}</p></div>
                <div class="stat-card"><h4>Negócios Fechados</h4><p>{{ analytics.total_accepted }}</p></div>
            {% endif %}
        </div>
        {% if session.user_type == 'supplier' %}
            <p>Você está logado como <strong>Fornecedor</strong>.</p>
            <a href="{{ url_for('add_product') }}" class="cta-button" style="display: inline-block; text-decoration: none; margin-bottom: 20px;">Adicionar Novo Produto</a>
            <a href="{{ url_for('list_open_rfqs') }}" class="cta-button" style="display: inline-block; text-decoration: none; margin-bottom: 20px; background-color: #17a2b8;">Ver Cotações Abertas</a>
            <div class="section-container">
                <div class="tabs"><a href="{{ url_for('dashboard', view='active') }}" class="{{ 'active' if view == 'active' }}">Cotações Ativas</a><a href="{{ url_for('dashboard', view='archived') }}" class="{{ 'active' if view == 'archived' }}">Histórico</a></div>
                {% if view == 'active' %}
                    <h3>Solicitações de Cotação Ativas</h3>
                    {% for quote in active_quotes %}<a href="{{ url_for('quote_detail', quote_id=quote.id) }}" class="quote-item"><p><strong>Produto:</strong> {{ quote.product.name }} | <strong>Comprador:</strong> {{ quote.buyer.company_name }} {% if quote.buyer.is_verified %}<span class="verified-seal-small" title="Empresa Verificada">✔</span>{% endif %} | <strong>Status:</strong> <span class="status-badge status-{{ quote.status }}">{{ quote.status }}</span></p><small>Recebido em: {{ quote.timestamp.strftime('%d/%m/%Y %H:%M') }}</small></a>{% else %}<p>Nenhuma cotação ativa no momento.</p>{% endfor %}
                {% else %}
                    <h3>Histórico de Cotações</h3>
                    {% for quote in archived_quotes %}<a href="{{ url_for('quote_detail', quote_id=quote.id) }}" class="quote-item"><p><strong>Produto:</strong> {{ quote.product.name }} | <strong>Comprador:</strong> {{ quote.buyer.company_name }} {% if quote.buyer.is_verified %}<span class="verified-seal-small" title="Empresa Verificada">✔</span>{% endif %} | <strong>Status:</strong> <span class="status-badge status-{{ quote.status }}">{{ quote.status }}</span></p><small>Recebido em: {{ quote.timestamp.strftime('%d/%m/%Y %H:%M') }}</small></a>{% else %}<p>Nenhuma cotação no histórico.</p>{% endfor %}
                {% endif %}
            </div>
            <div class="section-container">
                <h3>Seus Produtos Cadastrados</h3>
                <div class="product-management-grid">
                    {% for product in products %}<div class="product-management-card"><img src="{{ url_for('static', filename='uploads/' + product.images[0].filename) if product.images else 'https://via.placeholder.com/280x180' }}" alt="{{ product.name }}"><div class="product-management-info"><h4>{{ product.name }}</h4><p><strong>Preço:</strong> R$ {{ "%.2f"|format(product.base_price) if product.base_price else 'Sob consulta' }}</p></div><div class="product-management-actions"><a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn-edit">Editar</a><form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST" onsubmit="return confirm('Tem certeza? A ação não pode ser desfeita.');" style="flex: 1;"><button type="submit" class="btn-delete">Excluir</button></form></div></div>{% else %}<p>Você ainda não cadastrou nenhum produto.</p>{% endfor %}
                </div>
            </div>
        {% elif session.user_type == 'buyer' %}
            <p>Você está logado como <strong>Comprador</strong>.</p>
            <a href="{{ url_for('products') }}" class="cta-button" style="display: inline-block; text-decoration: none; margin-bottom: 20px;">Acessar Marketplace</a>
            <a href="{{ url_for('new_open_rfq') }}" class="cta-button" style="display: inline-block; text-decoration: none; margin-bottom: 20px; background-color: #17a2b8;">Criar Cotação Aberta (RFQ)</a>
            <div class="section-container">
                <h3>Meus Grupos de Cotação</h3>
                {% for group in quote_groups %}
                    <div class="quote-group-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 10px 0;">{{ group.name }}</h4>
                                <small>Criado em: {{ group.timestamp.strftime('%d/%m/%Y %H:%M') }} | {{ group.quotes.count() }} Itens</small>
                            </div>
                            <a href="{{ url_for('comparator', group_id=group.id) }}" class="cta-button" style="padding: 8px 15px; font-size: 0.9rem;">Ver Comparador</a>
                        </div>
                    </div>
                {% else %}
                    <p>Você ainda não criou nenhum grupo de cotação. Adicione itens ao carrinho e envie-os para começar.</p>
                {% endfor %}
            </div>
        {% endif %}
    </main>
</body>
</html>